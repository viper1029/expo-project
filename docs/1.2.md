# Earned Access — Consolidated Product + Build Spec **v1.2**
*(Single-source doc to reduce repo sprawl — iOS-first “real blocker” using Screen Time, built with Expo dev builds.)*

> **If anything conflicts inside this file:** the order is **Rules & Constants → Data/State → Backlog/Execution**.  
> If you still have separate v1.1 docs in the repo, treat this v1.2 file as the updated source of truth.

---

## 0) Decisions (locked for v1.2)

### Platform + stack
- **Expo dev builds** (React Native) remain the core stack.
- **Launch iOS first** with **real enforcement** using Apple Screen Time APIs (**FamilyControls / ManagedSettings / DeviceActivity**).
- Android enforcement ships later (post‑iOS launch).

### Monetization
- **Two tiers total: Free + Pro**
- **Pro includes a free trial from day 1** (recommended: **7 days**; adjustable).
- Free is intentionally useful (so users trust it), but Pro removes friction and adds power.

### Core product loop (unchanged)
**Modes → Focus Bank credits → Unlock Gate → Quests → Emergency (with guardrails)**

### Quests decision
- **Breathing quest = default** (beneficial, calming, and simple).
- **Copy‑text quest = optional** (kept as a *friction / intentionality* alternative).  
  If you want an even leaner v1.2, you can ship **Breathing only** and keep Copy‑text behind a flag.

---

## 1) Product positioning (App Store-safe)

**Positioning:** *“Earn your scroll: spend credits, not willpower.”*  
You’re not promising “unbreakable.” You’re promising **earned access + real system blocking**.

**What users get on day 1 (iOS):**
- Their chosen distracting apps are **actually blocked** during active modes.
- To use a blocked app, they must **earn or spend access** (credits/quests/emergency) and then receive a **time-limited unlock**.

---

## 2) Reality check: iOS Screen Time constraints (verified)

### What you cannot do
- You **cannot programmatically force-redirect** from the system shield into your app. Apple explicitly disallows opening the containing app from the shield action delegate. citeturn0search0

### What you can do
- Shield buttons are limited to returning system actions (e.g., **.close** and **.defer**). citeturn0search1
- You **can** coordinate state between the app and extensions using **App Groups**.
- You **can implement a timed unblock** using **DeviceActivity monitoring** to re-apply shields when the unlock window ends (documented by developers shipping real blockers). citeturn10view0

### Practical UX implication (v1.2 choice)
- **No “instant redirect” promise.**
- We still deliver a **real blocker** because iOS blocks the target app at OS level.  
- We reduce friction by storing the *last blocked app* in App Group storage so when the user opens Earned Access, it **auto-opens the Unlock Gate for that app**.

---

## 3) UX / UI: make it obvious, fast, and trust-building

### UX principles
1. **Always explain “why blocked”** (active mode name + strictness).
2. **One primary action** on the shield and in Unlock Gate (avoid choice overload).
3. **Always show the cost** (credits, cooldown, daily limits) *before* committing.
4. **No dead ends**: every blocked state has a path forward (earn, wait, or emergency).

### Tab structure (still correct)
- **Modes**
- **Focus**
- **Unlocks**
- **Progress**
- **Settings**

### “Real blocker” iOS flow (end-to-end)
**A) First run / onboarding**
1) Goal selection  
2) Screen Time authorization explanation → request  
3) Pick distracting apps (native picker)  
4) Create first mode (template: Work/Study/Sleep)  
5) Confirm unlock style defaults  
6) Land in Home tabs

**B) When user opens a blocked app**
1) iOS shows your **Shield UI** with:
   - “Blocked by Work mode”
   - “Next unlock: Earn access in Earned Access”
   - Button: “Close & unlock” (action = close)
2) Shield writes `last_blocked_app_token` into App Group (so the app can deep-link internally)
3) User opens Earned Access → app auto-navigates to **Unlock Gate(last_blocked_app)**

**C) Unlock Gate**
- Shows: balance, streak, reason blocked, available options (enabled/disabled with reasons)
- Options (v1.2):
  - **Credits unlock** (durations: 5/15/30; plan-gated)
  - **Breathing quest**
  - **Emergency unlock** (1/day global, strict guardrails)

**D) After successful unlock**
- App calls iOS native module to temporarily unshield the target app
- User can open it freely until the unlock ends
- On expiry, iOS re-applies shield (DeviceActivity monitor)

---

## 4) “Distracting apps” definition (what the user asked)

### iOS (v1.2)
- Users select apps using the system **FamilyActivityPicker**.
- iOS gives you **opaque ApplicationTokens**, not bundle IDs.
- You generally **cannot map tokens to bundle IDs**; for display, iOS recommends rendering tokens using SwiftUI `Label(token)` (app name/icon). citeturn14view0  
  **Product implication:**  
  - In RN screens, show **count** + “Manage selection” button (opens native picker), not a full custom list of app names (unless you embed a native list component).

### Android (later)
- Users can browse installed apps with label/icon/package.
- Your `appId` format stays consistent:  
  - iOS: `ios:<base64(token)>` (opaque)  
  - Android: `android:<packageName>`

---

## 5) Pricing plan (Free + Pro, with Pro trial day 1)

### Market reality (why Free baseline still matters)
Competitors commonly provide a useful free baseline and then upsell:
- **Opal** advertises a **free tier** and a **trial** for paid plans. citeturn17view0
- **one sec** is **free** but limits you to **1 target app**; Pro unlocks multiple apps and advanced features. citeturn16view0

This supports the model: **give meaningful value free** → upgrade when users want multi-app, stronger controls, or less friction.

### Recommended tier definition (v1.2)

#### Free (forever)
- 1 Mode (single schedule)
- Up to **3 distracting apps** (iOS selection)
- Credits unlock (limited): **5 min only** + fixed pricing
- Breathing quest (enabled)
- Emergency unlock (enabled but minimal)
- Basic Progress (today + streak)

#### Pro (subscription) + **7‑day free trial**
- Unlimited modes + schedules
- Unlimited distracting apps
- Strictness levels (Strict/Hard)
- More unlock options:
  - **Credit durations 5/15/30** & configurable pricing (within safe caps)
  - Quest variants (Breathing + optional Copy‑text)
  - Advanced limits & cooldown controls per mode
- Weekly review + insights
- (Later) Android enforcement

### Purchase options (Pro)
- Monthly subscription (auto-renew)
- Annual subscription (auto-renew, includes free trial)
- Lifetime (one-time non-consumable purchase)

### Best paywall / trial trigger moments
- Adding the **4th distracting app**
- Creating a **2nd mode**
- Choosing **15/30-minute unlocks**
- Enabling **Strict** or **Hard** mode

**Pricing suggestion (starter):**
- Monthly: **$6.99–$9.99**
- Yearly: **$39.99–$59.99**
Keep it simple: one monthly + one yearly.

### Trial downgrade behavior (v1.2)
When Pro trial ends or subscription lapses:
- User becomes **Free immediately** (no limbo state).
- App does **not delete user data**.
- App enforces Free limits with explicit UX explaining the change.

Concrete rules:
- **Modes:** keep the highest-priority mode (tie-breaker: most recently updated). Other modes stay in DB but are **locked** in UI and not enforced.
- **Distracting apps:** enforce the Free cap (3). Prompt user to pick the 3 to keep, or auto-keep the 3 most recently added with a banner.
- **Unlock durations:** hide 15/30 in UI; keep only 5.
- **Active grants:** honor existing grants until they expire (no rug-pull).

---

## 6) Rules & constants snapshot (engine truth — still local-first)

### Day boundary
- Day starts at **04:00 local time**.
- `day_id` is computed from local date with the 04:00 rule.

### Credits (Focus Bank)
- Earned by focus sessions and habits.
- Spent on credit unlocks.
- Balance carryover at day rollover: **min(10, balance)**.

### Streak
- Qualify per day if:
  - First completed focus session ≥ 20 minutes, OR
  - 2 valid habits completed (not suspended)
- Bonus awarded once per day on first qualification.

### Unlock methods (v1.2 minimum set)
- **CREDITS**: user spends credits for a timed unlock
- **QUEST**: breathing quest grants unlock
- **EMERGENCY**: 1/day global, 5 min unlock after 60s delay (guardrails)

(Token + partner are explicitly **out of v1.2** unless you decide to ship them later.)

---

## 7) iOS enforcement architecture (how “real blocker” is implemented)

### Components
1. **Main app (Expo RN)**  
   - owns rules engine + SQLite
   - runs Unlock Gate UX
2. **iOS Native Module (bridge)**  
   - requests Screen Time authorization
   - reads/writes selected apps
   - applies shields via ManagedSettingsStore
   - creates timed unlock windows using DeviceActivityCenter monitoring
3. **Extensions**
   - **DeviceActivityMonitor extension**: re-applies shield on schedule end / unlock end
   - **ManagedSettingsUI Shield extensions**:
     - configuration data source (custom shield UI)
     - action delegate (respond to button taps: close/defer)

### State sharing
- Use **App Group container** to share:
  - selected app tokens (opaque)
  - “last blocked app token”
  - active unlock windows (minimal mirror)
- The SQLite DB can remain app-owned; you mirror only what the extension needs.

### Key behaviors
- **Mode start** → apply shield to selected tokens
- **Mode end** → remove shield (or compute next active mode)
- **Unlock granted** → temporarily remove shield for that token until unlock expires
- **Unlock expired** → reapply shield automatically (via monitor)

---

## 8) Unknowns that are now resolved (so agents don’t drift)

- ✅ **App selection exists** (native picker on iOS; Android later).
- ✅ **“Redirect” is not promised**; instead we use “last blocked app” auto-navigation.
- ✅ **Pro trial included day 1** via RevenueCat (or StoreKit direct; RevenueCat recommended).
- ✅ **Copy-text quest optional**; breathing is default.

Remaining “watchouts” (not blockers):
- iOS token display in RN is limited; use native UI or show counts.
- Keep unlock durations aligned with what proves reliable on iOS (start with 15/30).

---

## 9) Execution plan (iOS-first, Expo)

### Phase 1 — Vertical slice (ship blocking + one unlock path)
- App boot + DB + event log (local-first)
- Basic mode schedule
- iOS Screen Time authorization + selection
- Apply shields on schedule
- Unlock Gate (credits unlock only)
- Re-apply shield at unlock expiry (DeviceActivity monitor)

### Phase 2 — Earned loop polish
- Focus sessions → earn credits
- Streak + day rollover
- Breathing quest unlock
- Progress tab

### Phase 3 — Monetization day-1 readiness
- RevenueCat integration
- Pro trial
- Tier gating enforcement
- Paywall placement (after onboarding or after first “blocked app” moment)

### Phase 4 — Android
- App picker
- Accessibility/overlay enforcement
- Parity with iOS rules engine

---

## 10) App Review / compliance checklist (practical)

### What to prepare for App Review
- **Clear in-app explanation**: “This app uses Screen Time APIs to block selected apps you choose.”
- Settings → Privacy page describing:
  - local-only storage of events
  - no selling of data
- “Reviewer Instructions” screen (or submission notes):
  1) Install
  2) Grant Screen Time authorization
  3) Select 1–3 apps
  4) Enable Work mode schedule (e.g., now → +10 minutes)
  5) Try opening blocked app → see shield
  6) Open Earned Access → unlock → return to blocked app

### Claims to avoid
- “Unbreakable”
- Medical or treatment claims

---

## 11) Minimal API contract (so code stays aligned)

### Domain
- `computeDayId(tsUtcMs, timezoneId) -> day_id`
- `RulesEngine.evaluateAppAccess(appId, nowMeta) -> AccessDecision`
- `RulesEngine.createUnlockAttempt(appId, nowMeta) -> attemptId + snapshot`

### iOS bridge (JS → native)
- `requestScreenTimeAuthorization(): Promise<"granted"|"denied">`
- `presentAppPicker(): Promise<void>` (native UI)
- `applyShieldsForActiveModes(): Promise<void>` (recompute + apply)
- `temporarilyUnshield(appId, durationSeconds): Promise<void>`
- `getLastBlockedAppId(): Promise<string|null>` (from App Group)

---

## 12) References (verification sources)
- Apple dev forum: cannot open containing app from ShieldActionDelegate citeturn0search0
- Apple docs: ShieldActionResponse.defer exists (shield refresh action) citeturn0search1
- Example: timed unblock and re-lock using DeviceActivity monitoring citeturn10view0
- iOS token naming: use SwiftUI `Label(token)` to display app name/icon citeturn14view0
- Competitor pricing patterns:
  - Opal free tier + trial citeturn17view0
  - one sec free baseline + upgrade for multiple apps citeturn16view0
